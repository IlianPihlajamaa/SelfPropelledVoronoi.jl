
import Pkg; Pkg.activate("example")

using Revise
using SelfPropelledVoronoi, StaticArrays, Random
using Statistics, BenchmarkTools, GLMakie, BenchmarkTools
import Quickhull, SIMD

K = Quickhull.HyperplaneKernelExactSIMD
point_indices = Int32[109, 78, 141]
pts = Quickhull.LiftedPoint{3, SVector{2, Float64}, Float64}[[3.3261264813431017, 5.974616854811815, 46.75916393169327], [4.353052741230266, 4.790588318088285, 41.89880460133628], [3.287293714534476, 6.306189528828045, 50.57432633911836], [5.651311762465148, 5.8216668913246625, 65.82913003012268], [5.050977028531911, 3.2079954199425362, 35.803603557129335], [0.32362552200522954, 3.2762491690059883, 10.838542095905586], [5.467042504899489, 5.430560238798605, 59.37953825759803], [0.4719760237625029, 5.037015049733611, 25.594281978249555], [4.518303687482703, 3.2358869217676345, 30.88603238278661], [6.557758686158914, 0.43136684505833184, 43.19027634090827], [6.39801206620268, 4.509626656017681, 61.2712909759403], [2.372875224978378, 3.126431727921078, 15.405112182667764], [4.427519995643554, 1.3250897375662247, 21.358796124426817], [4.174670647345292, 5.969863843714536, 53.067149326296445], [6.6641553503393185, 2.5641925291908803, 50.98604986021449], [5.931044207426734, 1.7766400431663316, 38.333735233432286], [0.2800543964396799, 6.083115053575581, 37.082719220003035], [1.470631303736611, 0.556119838213241, 2.4720257059843656], [2.067215169905703, 1.190494517310107, 5.690655754433688], [1.0984502639960723, 3.5942217608082463, 14.125023048340571], [1.312025395726509, 1.6413115440075012, 4.415314223523589], [0.622854294538975, 6.4596360892809415, 42.11484587816642], [6.380076704684908, 5.311589874502857, 68.91836575258431], [1.634165402850951, 3.134230562888863, 12.49389778522165], [5.370965768475274, 7.061685965140761, 78.71468195639919], [1.7517758685092322, 5.60253607695545, 34.457129187078635], [5.771708802026146, 0.9773918898052797, 34.26791740164323], [2.8528672214385606, 0.300290331283651, 8.22902566622102], [3.3855453849995425, 3.687012892629407, 25.055981624307165], [4.413130880305568, 6.722111477353569, 64.66250688067518], [3.4789747609649813, 4.642419942797273, 33.65532831271319], [2.055697392885033, 4.061814292830055, 20.724227120552843], [6.381552232058312, 0.0722958397775675, 40.72943557893757], [0.7948990304563377, 0.5421049073007302, 0.925742199139959], [3.041574960947818, 2.4649021292778808, 15.326920749983351], [0.5648584177597012, 1.4469385122649023, 2.412696090389362], [1.32446756238565, 5.9012739441830915, 36.579248488106046], [0.17123643295902102, 4.451675077925752, 19.846732915397777], [2.554030238542561, 0.19348319532787306, 6.560506206264054], [5.400169876867547, 1.842413864723607, 32.55632354795343], [2.8779279580837804, 1.8963100844424223, 11.878461268278306], [6.211952113315587, 3.197063957122408, 48.809567004057186], [4.025023394569431, 1.996856117969838, 20.188247682704798], [5.820742856509027, 3.8031239994811434, 48.34479955703032], [0.523128112681357, 2.2669397291256397, 5.412678757765787], [3.5594197509049983, 1.3695114550888448, 14.545030588752164], [4.615785740257584, 0.19273906585397457, 21.342626347471516], [1.5960616535249557, 5.228856908060616, 29.888357366826046], [4.501362016052123, 4.1578849965432445, 37.550267644036246], [2.80816990214989, 4.3410623321464445, 26.73064037092125], [10.397194293208578, 5.974616854811815, 143.79769573253046], [3.3261264813431017, -1.0964509570536602, 12.265322071115731], [10.397194293208578, -1.0964509570536602, 109.30385387195291], [-2.718015070635209, 4.790588318088285, 30.337342357604065], [4.353052741230266, -2.2804794937771904, 24.149654889470604], [-2.718015070635209, -2.2804794937771904, 12.588192645738392], [10.358361526399952, 6.306189528828045, 147.06367988510323], [3.287293714534476, -0.7648782830374303, 11.39133875348016], [10.358361526399952, -0.7648782830374303, 107.88069229946503], [-1.4197560494003278, 5.8216668913246625, 35.907512633354585], [5.651311762465148, -1.249400920540813, 33.49832729682516], [-1.4197560494003278, -1.249400920540813, 3.5767099000570566], [-2.020090783333565, 3.2079954199425362, 14.372001387281504], [5.050977028531911, 10.279063231808012, 131.17150986626442], [-2.020090783333565, 10.279063231808012, 109.73990769641658], [7.3946933338707055, 3.2762491690059883, 65.41529811940427], [0.32362552200522954, 10.347316980871463, 107.17170218112409], [7.3946933338707055, 10.347316980871463, 161.74845820462278], [-1.6040253069659869, 5.430560238798605, 32.06388169260769], [5.467042504899489, -1.6405075730668708, 32.579818847667426], [-1.6040253069659869, -1.6405075730668708, 5.264162282677082], [7.543043835627978, 5.037015049733611, 82.26903091744813], [0.4719760237625029, -2.0340527621318643, 4.360132006142929], [7.543043835627978, -2.0340527621318643, 61.034880945341506], [-2.5527641243827723, 3.2358869217676345, 16.98756884520256], [4.518303687482703, 10.306954733633109, 126.64838409348175], [-2.5527641243827723, 10.306954733633109, 112.7499205558977], [-0.5133091257065612, 0.43136684505833184, 0.4495636135492131], [6.557758686158914, 7.502434656923807, 99.29072476730414], [-0.5133091257065612, 7.502434656923807, 56.550012039945074], [-0.6730557456627952, 4.509626656017681, 20.789736613434915], [6.39801206620268, -2.5614411558477945, 47.49553919414598], [-0.6730557456627952, -2.5614411558477945, 7.013984831640586], [9.443943036843853, 3.126431727921078, 98.96263543250308], [2.372875224978378, 10.197499539786554, 109.61953369726317], [9.443943036843853, 10.197499539786554, 193.1770569470985], [-2.643547816221922, 1.3250897375662247, 8.744207869255018], [4.427519995643554, 8.3961575494317, 90.09839490670244], [-2.643547816221922, 8.3961575494317, 77.48380665153064], [-2.8963971645201836, 5.969863843714536, 44.028390847130645], [4.174670647345292, -1.1012039681509398, 18.640525193277732], [-2.8963971645201836, -1.1012039681509398, 9.601766714111935], [-0.406912461526157, 2.5641925291908803, 6.740661078103599], [6.6641553503393185, 9.635260341056355, 137.2492083733896], [-0.406912461526157, 9.635260341056355, 93.00381959127871], [-1.140023604438741, 1.7766400431663316, 4.456103661659564], [5.931044207426734, 8.847707855031807, 113.45921967844176], [-1.140023604438741, 8.847707855031807, 79.58158810666903], [7.3511222083051555, 6.083115053575581, 91.04328647647512], [0.2800543964396799, -0.9879527582898948, 1.0544811175778048], [7.3511222083051555, -0.9879527582898948, 55.01504837404988], [8.541699115602086, 0.556119838213241, 73.26989305593177], [1.470631303736611, 7.627187650078716, 60.33674788104333], [8.541699115602086, 7.627187650078716, 131.13461523099073], [9.138282981771178, 1.190494517310107, 84.92549305067416], [2.067215169905703, 8.261562329175582, 72.52679067754134], [9.138282981771178, 8.261562329175582, 151.7616279737818], [8.169518075861548, 3.5942217608082463, 79.6594556576961], [1.0984502639960723, -3.476846051057229, 13.295051445225289], [8.169518075861548, -3.476846051057229, 78.82948405458082], [8.383093207591985, 1.6413115440075012, 72.97015531166717], [1.312025395726509, 8.712379355872976, 77.62696467967291], [8.383093207591985, 8.712379355872976, 146.18180576781648], [7.69392210640445, 6.4596360892809415, 100.92333578535987], [0.622854294538975, -0.611431722584534, 0.7617962236083349], [7.69392210640445, -0.611431722584534, 59.57028613080178], [-0.6909911071805679, 5.311589874502857, 28.690455705123906], [6.380076704684908, -1.7594779373626181, 43.80114136972884], [-0.6909911071805679, -1.7594779373626181, 3.57323132226844], [8.705233214716426, 3.134230562888863, 85.60448654394872], [1.634165402850951, 10.205298374754339, 106.81861148163856], [8.705233214716426, 10.205298374754339, 179.92920024036562], [-1.7001020433902019, 7.061685965140761, 52.757755628205544], [5.370965768475274, -0.009381846724714649, 28.847361305181153], [-1.7001020433902019, -0.009381846724714649, 2.890434976987506], [8.822843680374708, 5.60253607695545, 109.23098110191529], [1.7517758685092322, -1.4685317349100258, 5.225304149929125], [8.822843680374708, -1.4685317349100258, 79.99915606476578], [-1.2993590098393293, 0.9773918898052797, 2.643628742707778], [5.771708802026146, 8.048459701670755, 98.09032606480419], [-1.2993590098393293, 8.048459701670755, 66.46603740586873], [9.923935033304037, 0.300290331283651, 98.57466082830163], [2.8528672214385606, 7.371358143149126, 62.47577225772951], [9.923935033304037, 7.371358143149126, 152.82140741981013], [10.456613196865018, 3.687012892629407, 122.9348236192671], [3.3855453849995425, -3.3840549192360685, 22.913745250297534], [10.456613196865018, -3.3840549192360685, 120.79258724525747], [-2.6579369315599077, 6.722111477353569, 52.25141144611868], [4.413130880305568, -0.34895633451190644, 19.59749469010258], [-2.6579369315599077, -0.34895633451190644, 7.186399255546084], [10.550042572830456, 4.642419942797273, 132.8554612138169], [3.4789747609649813, -2.428647869068202, 18.00159585936087], [10.550042572830456, -2.428647869068202, 117.20172876046459], [9.126765204750509, 4.061814292830055, 99.79617845208311], [2.055697392885033, -3.00925351903542, 13.28149851294138], [9.126765204750509, -3.00925351903542, 92.35344984447165], [-0.6895155798071633, 0.0722958397775675, 0.48065842324595226], [6.381552232058312, 7.143363651643043, 91.75185315010347], [-0.6895155798071633, 7.143363651643043, 51.503075994411844], [7.865966842321813, 0.5421049073007302, 62.167312095025736], [0.7948990304563377, 7.613172719166206, 58.592263320476995], [7.865966842321813, 7.613172719166206, 119.83383321636276], [10.112642772813293, 2.4649021292778808, 108.34128635745157], [3.041574960947818, 9.535969941143357, 100.18590096145435], [10.112642772813293, 9.535969941143357, 193.2002665689226], [7.635926229625177, 1.4469385122649023, 60.40100044255314], [0.5648584177597012, 8.518006324130377, 72.8754967700391], [7.635926229625177, 8.518006324130377, 130.8638011222029], [8.395535374251125, 5.9012739441830915, 105.31004838459623], [1.32446756238565, -1.169793867682384, 3.122632016679097], [8.395535374251125, -1.169793867682384, 71.85343191316929], [7.2423042448244965, 4.451675077925752, 72.26838177402817], [0.17123643295902102, -2.6193927339397236, 6.890540210588749], [7.2423042448244965, -2.6193927339397236, 59.312189069219144], [9.625098050408036, 0.19348319532787306, 92.67994822684287], [2.554030238542561, 7.264551007193349, 59.29677179550367], [9.625098050408036, 7.264551007193349, 145.4162138160825], [-1.670897934997929, 1.842413864723607, 6.186388758106121], [5.400169876867547, 8.913481676589083, 108.61199029791698], [-1.670897934997929, 8.913481676589083, 82.24205550806967], [9.948995769949256, 1.8963100844424223, 102.57850876682623], [2.8779279580837804, 8.967377896307898, 88.69633566711174], [9.948995769949256, 8.967377896307898, 179.39638316565964], [-0.8591156985498882, 3.197063957122408, 10.959297729426053], [6.211952113315587, 10.268131768987883, 144.02287908342424], [-0.8591156985498882, 10.268131768987883, 106.17260980879311], [-3.046044417296044, 1.996856117969838, 13.265820948013967], [4.025023394569431, 9.067923929835313, 98.42805772411113], [-3.046044417296044, 9.067923929835313, 91.5056309894203], [-1.2503249553564482, 3.8031239994811434, 16.027064649416552], [5.820742856509027, -3.267943812384332, 44.560504162501914], [-1.2503249553564482, -3.267943812384332, 12.242769254888145], [7.594195924546833, 2.2669397291256397, 62.810827475891955], [0.523128112681357, 9.338007540991114, 87.47204785788448], [7.594195924546833, 9.338007540991114, 144.87019657601064], [3.5594197509049983, 8.44057926695432, 83.91284732487172], [-2.4552820716078916, 0.19273906585397457, 6.065558398665403], [4.615785740257584, 7.26380687771945, 74.06836835676964], [-2.4552820716078916, 7.26380687771945, 58.791300407963526], [8.667129465390431, 5.228856908060616, 102.46007773481224], [1.5960616535249557, -1.842210903804859, 5.941153815950331], [8.667129465390431, -1.842210903804859, 78.51287418393653], [-2.569705795813353, 4.1578849965432445, 23.891395521516156], [4.501362016052123, -2.913182815322231, 28.748894115045587], [-2.569705795813353, -2.913182815322231, 15.090021992525497], [9.879237714015366, 4.3410623321464445, 116.44415998160429], [2.80816990214989, -2.730005479719031, 15.338748118636458], [9.879237714015366, -2.730005479719031, 105.0522677293195]]

function cofactor(i, mat′::SMatrix{D, Dp1, T, L}) where {D, Dp1, T, L}
    # drop ith index
    ind = SVector{D}(j >= i ? j+1 : j for j = 1:D)
    cut = mat′[:, ind]
    (-1)^(i+1) * Quickhull._det_expanded(cut)
end

function cofactor_perm(i, mat′::SMatrix{D, Dp1, T, L}) where {D, Dp1, T, L}
    ind = SVector{D}(j >= i ? j+1 : j for j = 1:D)
    cut = mat′[:, ind]
    Quickhull._perm_expanded(cut)
end


function get_cofactor_tuple(i, T, mat′)
    c1 = cofactor(i, mat′)
    c2 = cofactor_perm(i, mat′)
    SIMD.Vec{2, T}((c1, c2))
end

function construct_cofactor_pairs(
    ::Type{K}, point_indices::SVector{D, I}, pts::AbstractVector, mat′::SMatrix{D, Dp1, T, L}
    ) where {D, Dp1, T, L, I, K <: Quickhull.HyperplaneKernelExactSIMD}

    cofactor_pairs = SVector{Dp1, SIMD.Vec{2, T}}(
            # get_cofactor_tuple(i)
            # for i = 1:D+1
            ntuple(i -> get_cofactor_tuple(i, T, mat′), Dp1)...
        )
    return cofactor_pairs
end


function make_kernel(::Type{K}, point_indices::SVector{D, I}, pts::AbstractVector) where {D, I, K <: Quickhull.HyperplaneKernelExactSIMD}

    pt_D = length(first(pts))
    if D != pt_D
        # fallback when not simplex
        return Quickhull.make_kernel(HyperplaneKernelExact_A, point_indices, pts)
    end

    mat = Quickhull.pointmatrix(pts, point_indices)'
    T = eltype(mat)
    mat′ = hcat(mat, ones(SVector{D, T}))

    cofactor_pairs = construct_cofactor_pairs(K, point_indices, pts, mat′)
    Quickhull.HyperplaneKernelExactSIMD(cofactor_pairs, one(T))
end

S = make_kernel(K, SVector{3, Int32}(point_indices), pts) 
S2 = Quickhull.make_kernel(K, SVector{3, Int32}(point_indices), pts)

@btime make_kernel($K, $SVector{3, Int32}($point_indices), $pts)
@btime Quickhull.make_kernel($K, $SVector{3, Int32}($point_indices), $pts)

@code_warntype make_kernel(K, SVector{3, Int32}(point_indices), pts)

@profview for i in 1:1000000
    S = make_kernel(K, SVector{3, Int32}(point_indices), pts) 
end

